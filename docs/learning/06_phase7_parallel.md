# Phase 7: ä¸¦åˆ—å­¦ç¿’ (Parallel Training)

## ğŸ“… ä½œæˆæ—¥: 2026-01-17

---

## æ¦‚è¦

Phase 7ã§ã¯ã€SubprocVecEnvã‚’ä½¿ç”¨ã—ãŸä¸¦åˆ—å­¦ç¿’ã«ã‚ˆã‚Šã€å­¦ç¿’é€Ÿåº¦ã®å¤§å¹…ãªå‘ä¸Šã‚’å®Ÿç¾ã—ãŸã€‚
AWSã‹ã‚‰GCPã¸ã®ç§»è¡Œã¨åˆã‚ã›ã¦ã€ã‚³ã‚¹ãƒˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æœ€é©åŒ–ã‚‚é”æˆã€‚

---

## æŠ€è¡“çš„èƒŒæ™¯

### ãªãœä¸¦åˆ—å­¦ç¿’ãŒå¿…è¦ã‹

1. **CPUãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã®è§£æ¶ˆ**
   - ã‚·ãƒ³ã‚°ãƒ«ç’°å¢ƒã§ã¯1ã¤ã®CPUã‚³ã‚¢ã—ã‹ä½¿ç”¨ã•ã‚Œãªã„
   - é«˜æ€§èƒ½ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã‚‚ã‚³ã‚¢ä½¿ç”¨ç‡ãŒä½ã„

2. **I/Oå¾…ã¡ã®æ´»ç”¨**
   - 1ã¤ã®ç’°å¢ƒãŒã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œä¸­ã€ä»–ã®ç’°å¢ƒã¯æ¬¡ã®æº–å‚™å¯èƒ½
   - ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³åŠ¹æœã§ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆå‘ä¸Š

3. **ãƒãƒƒãƒå­¦ç¿’ã®åŠ¹ç‡åŒ–**
   - è¤‡æ•°ç’°å¢ƒã‹ã‚‰ã®çµŒé¨“ã‚’åŒæ™‚åé›†
   - ã‚ˆã‚Šå®‰å®šã—ãŸå‹¾é…æ¨å®š

---

## å®Ÿè£…

### SubprocVecEnv ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Main Process (Training)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚          MaskablePPO Model              â”‚    â”‚
â”‚  â”‚  - Policy Network                       â”‚    â”‚
â”‚  â”‚  - Value Network                        â”‚    â”‚
â”‚  â”‚  - batch_size=256                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                      â”‚                           â”‚
â”‚                      â–¼                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚           SubprocVecEnv                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚       â”‚         â”‚         â”‚         â”‚           â”‚
â”‚       â–¼         â–¼         â–¼         â–¼           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Env 0  â”‚ â”‚ Env 1  â”‚ â”‚ Env 2  â”‚ â”‚ Env 3  â”‚   â”‚
â”‚  â”‚(å­ãƒ—ãƒ­ â”‚ â”‚(å­ãƒ—ãƒ­ â”‚ â”‚(å­ãƒ—ãƒ­ â”‚ â”‚(å­ãƒ—ãƒ­ â”‚   â”‚
â”‚  â”‚ ã‚»ã‚¹)  â”‚ â”‚ ã‚»ã‚¹)  â”‚ â”‚ ã‚»ã‚¹)  â”‚ â”‚ ã‚»ã‚¹)  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚³ãƒ¼ãƒ‰å®Ÿè£…

```python
# train_gcp_phase7_parallel.py

from stable_baselines3.common.vec_env import SubprocVecEnv
from sb3_contrib import MaskablePPO
from sb3_contrib.common.wrappers import ActionMasker

NUM_ENVS = int(os.getenv("NUM_ENVS", "4"))

class ParallelOFCEnv(gym.Env):
    """ä¸¦åˆ—å®Ÿè¡Œç”¨ã®OFCç’°å¢ƒãƒ©ãƒƒãƒ‘ãƒ¼"""
    def __init__(self, env_id: int = 0):
        super().__init__()
        self.env = OFC3MaxEnv()
        self.env_id = env_id
        self.learning_agent = "player_0"

        self.observation_space = self.env.observation_space(self.learning_agent)
        self.action_space = self.env.action_space(self.learning_agent)

    def reset(self, seed=None, options=None):
        self.env.reset(seed=seed, options=options)
        self._play_opponents()  # ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—
        return self.env.observe(self.learning_agent), {}

    def step(self, action):
        self.env.step(action)
        self._play_opponents()
        # ... å ±é…¬è¨ˆç®—ã€çµ‚äº†åˆ¤å®š
        return obs, reward, terminated, truncated, info

    def _play_opponents(self):
        """ç›¸æ‰‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒ—ãƒ¬ã‚¤ï¼ˆè»½é‡åŒ–ï¼‰"""
        while self.env.agent_selection != self.learning_agent:
            valid_actions = self.env.get_valid_actions(agent)
            action = random.choice(valid_actions) if valid_actions else 0
            self.env.step(action)

def make_env(env_id: int):
    def _init():
        env = ParallelOFCEnv(env_id=env_id)
        env = ActionMasker(env, mask_fn)
        return env
    return _init

# ä¸¦åˆ—ç’°å¢ƒä½œæˆ
env = SubprocVecEnv([make_env(i) for i in range(NUM_ENVS)])

# ãƒ¢ãƒ‡ãƒ«ä½œæˆï¼ˆãƒãƒƒãƒã‚µã‚¤ã‚ºå¢—åŠ ï¼‰
model = MaskablePPO(
    "MultiInputPolicy",
    env,
    learning_rate=1e-4,
    batch_size=256,  # ä¸¦åˆ—ç’°å¢ƒç”¨ã«å¢—åŠ 
    n_steps=2048,
    ...
)
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ

### FPS (Frames Per Second)

| æ§‹æˆ | ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ | FPS | æ”¹å–„ç‡ |
|:---|:---|---:|:---:|
| ã‚·ãƒ³ã‚°ãƒ«ç’°å¢ƒ | n2-standard-4 | 129 | - |
| ã‚·ãƒ³ã‚°ãƒ«ç’°å¢ƒ | n2-standard-16 | 186 | 1.4x |
| **ä¸¦åˆ—4ç’°å¢ƒ** | **n2-standard-4** | **4,494-12,382** | **30-90x** |

### ã‚³ã‚¹ãƒˆåŠ¹ç‡

| æ§‹æˆ | æ™‚é–“å˜ä¾¡ | 20Mã‚¹ãƒ†ãƒƒãƒ—æ‰€è¦æ™‚é–“ | ç·ã‚³ã‚¹ãƒˆ |
|:---|---:|---:|---:|
| n2-standard-16 (ã‚·ãƒ³ã‚°ãƒ«) | $0.76 | ~30æ™‚é–“ | ~$23 |
| **n2-standard-4 (ä¸¦åˆ—)** | **$0.19** | **~10æ™‚é–“** | **~$2** |

**ã‚³ã‚¹ãƒˆå‰Šæ¸›ç‡: ç´„90%**

---

## è¨­è¨ˆä¸Šã®å·¥å¤«

### 1. è»½é‡ãªç›¸æ‰‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼

MCTSæ•™å¸«ãƒ¢ãƒ‡ãƒ«ã®ä»£ã‚ã‚Šã«ãƒ©ãƒ³ãƒ€ãƒ ãƒ—ãƒ¬ã‚¤ã‚’æ¡ç”¨:
- è¨ˆç®—ã‚³ã‚¹ãƒˆã‚’å¤§å¹…å‰Šæ¸›
- ä¸¦åˆ—åŒ–ã¨ã®ç›¸æ€§ãŒè‰¯ã„
- åŸºç¤çš„ãªæˆ¦ç•¥å­¦ç¿’ã«ã¯ååˆ†

### 2. è‡ªå‹•ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆç®¡ç†

```python
class ParallelCallback(BaseCallback):
    def _cleanup_old_checkpoints(self):
        """æœ€æ–°2ã¤ã¨100ä¸‡ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã®ç¯€ç›®ã®ã¿ä¿æŒ"""
        for f in sorted_files[:-2]:
            step = get_step(f)
            if step % 1_000_000 == 0:
                continue  # ç¯€ç›®ã¯ä¿æŒ
            os.remove(f)
```

### 3. è‡ªå‹•ãƒ¬ã‚¸ãƒ¥ãƒ¼ãƒ 

```python
# ä¸¦åˆ—ç”¨ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’å„ªå…ˆæ¤œç´¢
checkpoints = glob.glob("models/p7_parallel_*.zip")
if not checkpoints:
    checkpoints = glob.glob("models/p7_mcts_*.zip")

if checkpoints:
    latest = max(checkpoints, key=lambda f: int(f.split('_')[-1].replace('.zip', '')))
    model = MaskablePPO.load(latest, env=env)
```

---

## å­¦ç¿’é€²æ— (2026/01/17)

### Discordé€šçŸ¥ãƒ­ã‚°

| æ™‚åˆ» | ã‚¹ãƒ†ãƒƒãƒ— | é€²æ— | ã‚²ãƒ¼ãƒ æ•° | ãƒ•ã‚¡ã‚¦ãƒ«ç‡ | Royalty | FPS |
|:---|---:|---:|---:|---:|---:|---:|
| 14:14 | é–‹å§‹ | 0% | - | - | - | - |
| 14:18 | 2,300,000 | 11.5% | 20,000 | 37.6% | 4.39 | 12,382 |
| 14:21 | 2,400,000 | 12.0% | 40,000 | 32.8% | 5.29 | 6,468 |
| 14:24 | 2,500,000 | 12.5% | 60,000 | 34.0% | 5.17 | 4,494 |
| 14:27 | 2,600,000 | 13.0% | 80,000 | 39.2% | 3.73 | 3,513 |
| 14:30 | 2,700,000 | 13.5% | 100,000 | 34.6% | 4.21 | 2,908 |
| 14:33 | 2,800,000 | 14.0% | 120,000 | 33.4% | 4.94 | 2,520 |
| 14:36 | 2,900,000 | 14.5% | 140,000 | 35.6% | 4.66 | 2,240 |
| 14:39 | 3,000,000 | 15.0% | 160,000 | 32.2% | 4.49 | 2,028 |
| 14:42 | 3,100,000 | 15.5% | 180,000 | 35.4% | 4.18 | 1,865 |
| 14:45 | 3,200,000 | 16.0% | 200,000 | 39.6% | 4.17 | 1,731 |
| 14:48 | 3,300,000 | 16.5% | 220,000 | 32.8% | 4.86 | 1,624 |
| 14:51 | 3,400,000 | 17.0% | 240,000 | 33.6% | 4.95 | 1,536 |
| 14:54 | 3,500,000 | 17.5% | 260,000 | 37.8% | 4.00 | 1,460 |

### è¦³å¯Ÿã•ã‚ŒãŸå‚¾å‘

1. **ãƒ•ã‚¡ã‚¦ãƒ«ç‡**: 32-40%ã®ç¯„å›²ã§å¤‰å‹•ï¼ˆå¹³å‡ç´„35%ï¼‰
2. **å¹³å‡ãƒ­ã‚¤ãƒ¤ãƒªãƒ†ã‚£**: 4.0-5.3ã®ç¯„å›²ã§å®‰å®š
3. **FPS**: åˆæœŸãƒãƒ¼ã‚¹ãƒˆ(12,382)ã‹ã‚‰å¾ã€…ã«å®‰å®š(1,460å‰å¾Œ)ã¸åæŸ
4. **å­¦ç¿’ã®å®‰å®šæ€§**: å¤§ããªå´©å£Šãªãé †èª¿ã«é€²è¡Œä¸­

---

## ç’°å¢ƒå¤‰æ•°

```bash
# ä¸¦åˆ—ç’°å¢ƒæ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 4ï¼‰
export NUM_ENVS=4

# ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
export CLOUD_PROVIDER=gcs
export GCS_BUCKET=your-bucket-name

# Discordé€šçŸ¥
export DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/...
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 1. venvå•é¡Œ (Mac venvã®ã‚³ãƒ”ãƒ¼)

**ç—‡çŠ¶**: `source .venv/bin/activate` ãŒå‹•ã‹ãªã„

**åŸå› **: Macç”¨venvãŒLinuxã«ã‚³ãƒ”ãƒ¼ã•ã‚ŒãŸ

**è§£æ±º**:
```bash
rm -rf .venv
python3 -m venv venv_linux
source venv_linux/bin/activate
pip install -r requirements.txt
```

### 2. SSHæ¥ç¶šã®ä¸å®‰å®šã•

**ç—‡çŠ¶**: gcloud compute ssh ãŒé »ç¹ã«åˆ‡æ–­

**è§£æ±º**: ç›´æ¥SSHã‚’ä½¿ç”¨
```bash
ssh -i ~/.ssh/google_compute_engine naoai@INSTANCE_IP "command"
```

### 3. ãƒ¡ãƒ¢ãƒªä¸è¶³

**ç—‡çŠ¶**: OOM (Out of Memory) ã‚¨ãƒ©ãƒ¼

**è§£æ±º**:
- NUM_ENVS ã‚’æ¸›ã‚‰ã™ï¼ˆ4 â†’ 2ï¼‰
- batch_size ã‚’æ¸›ã‚‰ã™ï¼ˆ256 â†’ 128ï¼‰

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. [ ] 20Mã‚¹ãƒ†ãƒƒãƒ—åˆ°é”
2. [ ] æœ€çµ‚ãƒ¢ãƒ‡ãƒ«ã®è©•ä¾¡
3. [ ] Phase 4ãƒ¢ãƒ‡ãƒ«ï¼ˆãƒ•ã‚¡ã‚¦ãƒ«ç‡25%ï¼‰ã¨ã®æ¯”è¼ƒ
4. [ ] å¿…è¦ã«å¿œã˜ã¦ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´

---

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | èª¬æ˜ |
|:---|:---|
| `src/python/train_gcp_phase7_parallel.py` | ä¸¦åˆ—å­¦ç¿’ã‚¹ã‚¯ãƒªãƒ—ãƒˆ |
| `src/python/ofc_3max_env.py` | 3äººå¯¾æˆ¦ç’°å¢ƒ |
| `src/python/cloud_storage.py` | ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æŠ½è±¡åŒ– |
| `src/python/notifier.py` | Discordé€šçŸ¥ |
