# Phase 5: 3人対戦 (3-Max) Self-Play 技術解説

## 📅 開始: 2026-01-16

---

## 🎯 概要

Phase 5では、2人対戦から**3人対戦（3-Max）**への拡張を行い、より実践的なポーカー戦略を学習させます。

### なぜ3人対戦が重要か？

1. **アウツ計算の複雑化**
   - 2人より多くのカードが場に出る
   - 「枯れている」スートの判断がより重要に

2. **ポジション戦略**
   - ボタン（BTN）は最後に行動 → 後出し有利
   - SB/BBは先に行動 → 不利な状況での判断力

3. **リスク管理**
   - ファウル時は2人に支払い（×2のダメージ）
   - より慎重な判断が求められる

---

## 🔧 技術的実装

### 1. 3人対戦環境 (`ofc_3max_env.py`)

```python
# PettingZoo互換のAECEnv
class OFC3MaxEnv(AECEnv):
    NUM_PLAYERS = 3
    possible_agents = ["player_0", "player_1", "player_2"]
```

### 2. 観測空間の設計

| チャンネル | サイズ | 説明 |
|:---|---:|:---|
| `my_board` | 162 | 自分のボード（3段 × 54カード） |
| `my_hand` | 270 | 手札（5枚 × 54カード） |
| `next_opponent_board` | 162 | 下家のボード |
| `prev_opponent_board` | 162 | 上家のボード |
| `my_discards` | 54 | 自分の捨て札履歴 |
| `unseen_probability` | 54 | 見えない札の残存確率 |
| `position_info` | 3 | ポジション（One-hot） |

**合計: 約720次元**

### 3. 重要な設計判断

> **相手の捨て札は見えない**

実戦では相手の捨て札は非公開です。AIには「自分が見える情報」のみを入力します：
- 自分のボード（公開）
- 自分の手札（私的情報）
- 相手のボード（公開）
- 自分の捨て札（自分だけが知る「確定死に札」）

### 4. 確率マップ（Probability Map）

```python
def _calculate_unseen_probability(self, player_idx):
    # 見えているカード
    seen = 自分のボード + 自分の手札 + 自分の捨て札 + 相手のボード
    
    # 見えていないカードの残存確率
    unseen_count = 54 - len(seen)
    prob = 1.0 / unseen_count  # 等確率
    
    return [prob if card not in seen else 0 for card in range(54)]
```

---

## 📊 スコアリング（Triangle Scoring）

3人戦のスコアは**総当たり戦**で計算されます。

```
A vs B: +3 (Aの勝ち)
A vs C: -2 (Aの負け)
B vs C: +1 (Bの勝ち)

Aの収支 = (A vs B) + (A vs C) = +3 + (-2) = +1
Bの収支 = (B vs A) + (B vs C) = -3 + (+1) = -2
Cの収支 = (C vs A) + (C vs B) = +2 + (-1) = +1

合計: +1 + (-2) + (+1) = 0 ✅
```

---

## 🎓 期待される学習成果

### 1. アウツ・ブロック戦略
- 「上家がハートを集めているから、自分はハートのフラッシュに行かない」
- 「下家にジョーカーを引かせたくないから、自分が使ってしまう」

### 2. ポジション戦略
- 「最後の手番だから、相手がファウルしそうなのを見てから安全策を取る」

### 3. リスク管理
- 「2人相手にファウルすると-6点ではなく-12点（倍払い）になる」
- 「3人戦ではより慎重になる」

---

## 🚀 学習設定

| 項目 | 値 |
|:---|:---|
| 目標ステップ | 20,000,000 |
| チェックポイント保存 | 100万ステップごと |
| Discord通知 | 50万ステップごと |
| 対戦相手 | Latest 80% / Past 20% |
| FPS | 約378 |

---

## 📁 関連ファイル

| ファイル | 説明 |
|:---|:---|
| `src/python/ofc_3max_env.py` | 3人対戦環境 |
| `src/python/train_phase5_3max.py` | 学習スクリプト |
| `src/cpp/game.hpp` | C++エンジン（3人対応） |
